<app-navbar></app-navbar>
<app-sidenav></app-sidenav>

<div class="page-content">
  <h1 class="page-title">Inventario</h1>

  <div class="card" style="padding: 14px 16px; margin-bottom: 14px;">
    <!-- Toolbar -->
    <div class="filters-row">
      <div class="filters-left">
        <button class="btn btn-add"
                (click)="openAddForm()"
                [disabled]="loading">
          + Agregar un producto
        </button>

        <button class="btn btn-edit"
                (click)="onEditButton()"
                [disabled]="loading || deleteMode || products.length === 0">
          {{ editMode ? 'Guardar cambios' : 'Actualizar productos' }}
        </button>

        <button class="btn btn-delete"
                (click)="onDeleteButton()"
                [disabled]="loading || editMode || products.length === 0">
          {{ deleteButtonLabel }}
        </button>
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <div class="card" *ngIf="!loading; else loadingTpl">
    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th *ngIf="editMode || deleteMode" class="col-select"></th>
            <th>Nombre</th>
            <th>Stock</th>
            <th>Precio 1</th>
            <th>Precio 2</th>
            <th>Precio 3</th>
            <th>Precio 4</th>
          </tr>
        </thead>

        <tbody>
          <!-- Sin productos -->
          <tr *ngIf="products.length === 0">
            <td [attr.colspan]="(editMode || deleteMode) ? 7 : 6" class="muted" style="padding: 18px;">
              Todavía no hay productos cargados.
            </td>
          </tr>

          <!-- Con productos -->
          <tr *ngFor="let p of (editMode ? editedProducts : products); let i = index">

            <!-- Checkbox de selección (para editar o eliminar) -->
            <td *ngIf="editMode || deleteMode" class="col-select">
              <ng-container *ngIf="deleteMode; else editCheckbox">
                <input type="checkbox"
                       [checked]="isSelected(p.id)"
                       (change)="toggleSelected(p.id, $event.target.checked)" />
              </ng-container>
              <ng-template #editCheckbox>
                <input type="checkbox"
                       [checked]="isEditSelected(p.id)"
                       (change)="toggleEditSelected(p.id, $event.target.checked)" />
              </ng-template>
            </td>

            <!-- Nombre -->
            <td>
              <ng-container *ngIf="editMode && isEditSelected(p.id); else nameRead">
                <input type="text"
                       [(ngModel)]="editedProducts[i].title"
                       [class.input-error]="editedErrors[p.id]?.title" />
                <div class="error-message" *ngIf="editedErrors[p.id]?.title">
                  {{ editedErrors[p.id]?.title }}
                </div>
              </ng-container>
              <ng-template #nameRead>
                <strong>{{ p.title }}</strong>
              </ng-template>
            </td>

            <!-- Stock -->
            <td>
              <ng-container *ngIf="editMode && isEditSelected(p.id); else stockRead">
                <input type="number"
                       min="0"
                       [(ngModel)]="editedProducts[i].stock"
                       [class.input-error]="editedErrors[p.id]?.stock" />
                <div class="error-message" *ngIf="editedErrors[p.id]?.stock">
                  {{ editedErrors[p.id]?.stock }}
                </div>
              </ng-container>
              <ng-template #stockRead>
                {{ p.stock }}
              </ng-template>
            </td>

            <!-- Precio 1 -->
            <td>
              <ng-container *ngIf="editMode && isEditSelected(p.id); else price1Read">
                <input type="number"
                       min="0"
                       step="0.01"
                       [(ngModel)]="editedProducts[i].price"
                       [class.input-error]="editedErrors[p.id]?.price" />
                <div class="error-message" *ngIf="editedErrors[p.id]?.price">
                  {{ editedErrors[p.id]?.price }}
                </div>
              </ng-container>
              <ng-template #price1Read>
                {{ p.price | currency:'ARS':'symbol-narrow':'1.2-2' }}
              </ng-template>
            </td>

            <!-- Precio 2 -->
            <td>
              <ng-container *ngIf="editMode && isEditSelected(p.id); else price2Read">
                <input type="number"
                       min="0"
                       step="0.01"
                       [(ngModel)]="editedProducts[i].price2"
                       [class.input-error]="editedErrors[p.id]?.price2" />
                <div class="error-message" *ngIf="editedErrors[p.id]?.price2">
                  {{ editedErrors[p.id]?.price2 }}
                </div>
              </ng-container>
              <ng-template #price2Read>
                {{ p.price2 | currency:'ARS':'symbol-narrow':'1.2-2' }}
              </ng-template>
            </td>

            <!-- Precio 3 -->
            <td>
              <ng-container *ngIf="editMode && isEditSelected(p.id); else price3Read">
                <input type="number"
                       min="0"
                       step="0.01"
                       [(ngModel)]="editedProducts[i].price3"
                       [class.input-error]="editedErrors[p.id]?.price3" />
                <div class="error-message" *ngIf="editedErrors[p.id]?.price3">
                  {{ editedErrors[p.id]?.price3 }}
                </div>
              </ng-container>
              <ng-template #price3Read>
                {{ p.price3 | currency:'ARS':'symbol-narrow':'1.2-2' }}
              </ng-template>
            </td>

            <!-- Precio 4 -->
            <td>
              <ng-container *ngIf="editMode && isEditSelected(p.id); else price4Read">
                <input type="number"
                       min="0"
                       step="0.01"
                       [(ngModel)]="editedProducts[i].price4"
                       [class.input-error]="editedErrors[p.id]?.price4" />
                <div class="error-message" *ngIf="editedErrors[p.id]?.price4">
                  {{ editedErrors[p.id]?.price4 }}
                </div>
              </ng-container>
              <ng-template #price4Read>
                {{ p.price4 | currency:'ARS':'symbol-narrow':'1.2-2' }}
              </ng-template>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Cancelar edición -->
    <div style="padding: 12px 14px;" *ngIf="editMode">
      <button class="btn btn-cancel"
              (click)="cancelEdit()"
              [disabled]="loading">
        Cancelar cambios
      </button>
    </div>
  </div>

  <ng-template #loadingTpl>
    <div class="muted">Cargando inventario...</div>
  </ng-template>
</div>

<!-- MODAL PARA AGREGAR PRODUCTO -->
<div class="modal-backdrop" *ngIf="showAddForm">
  <div class="modal-card">
    <h2>Agregar producto</h2>

    <label>
      Nombre del producto *
      <input type="text"
             [(ngModel)]="newProduct.title"
             placeholder="Ej: Coca Cola lata"
             class="modal-input"
             [class.input-error]="newProductErrors.title" />
      <div class="error-message" *ngIf="newProductErrors.title">
        {{ newProductErrors.title }}
      </div>
    </label>

    <label>
      Stock inicial
      <input type="number"
             min="0"
             [(ngModel)]="newProduct.stock"
             class="modal-input"
             [class.input-error]="newProductErrors.stock" />
      <div class="error-message" *ngIf="newProductErrors.stock">
        {{ newProductErrors.stock }}
      </div>
    </label>

    <label>
      Precio 1
      <input type="number"
             min="0"
             step="0.01"
             [(ngModel)]="newProduct.price"
             class="modal-input"
             [class.input-error]="newProductErrors.price" />
      <div class="error-message" *ngIf="newProductErrors.price">
        {{ newProductErrors.price }}
      </div>
    </label>

    <label>
      Precio 2
      <input type="number"
             min="0"
             step="0.01"
             [(ngModel)]="newProduct.price2"
             class="modal-input"
             [class.input-error]="newProductErrors.price2" />
      <div class="error-message" *ngIf="newProductErrors.price2">
        {{ newProductErrors.price2 }}
      </div>
    </label>

    <label>
      Precio 3
      <input type="number"
             min="0"
             step="0.01"
             [(ngModel)]="newProduct.price3"
             class="modal-input"
             [class.input-error]="newProductErrors.price3" />
      <div class="error-message" *ngIf="newProductErrors.price3">
        {{ newProductErrors.price3 }}
      </div>
    </label>

    <label>
      Precio 4
      <input type="number"
             min="0"
             step="0.01"
             [(ngModel)]="newProduct.price4"
             class="modal-input"
             [class.input-error]="newProductErrors.price4" />
      <div class="error-message" *ngIf="newProductErrors.price4">
        {{ newProductErrors.price4 }}
      </div>
    </label>

    <div class="modal-actions">
      <button class="btn btn-cancel"
              type="button"
              (click)="closeAddForm()"
              [disabled]="loading">
        Cancelar
      </button>
      <button class="btn btn-add"
              type="button"
              (click)="saveNewProduct()"
              [disabled]="loading">
        Guardar
      </button>
    </div>
  </div>
</div>

<!-- MODAL CONFIRMAR GUARDAR CAMBIOS -->
<div class="modal-backdrop" *ngIf="showConfirmUpdate">
  <div class="modal-card">
    <h2>Guardar cambios</h2>
    <p *ngIf="editSelectedIds.size === 1">
      ¿Deseas guardar los cambios del producto seleccionado?
    </p>
    <p *ngIf="editSelectedIds.size > 1">
      ¿Deseas guardar los cambios de {{ editSelectedIds.size }} productos?
    </p>

    <div class="modal-actions">
      <button class="btn btn-cancel"
              type="button"
              (click)="showConfirmUpdate = false"
              [disabled]="loading">
        Cancelar
      </button>
      <button class="btn btn-edit"
              type="button"
              (click)="confirmUpdate()"
              [disabled]="loading">
        Aceptar
      </button>
    </div>
  </div>
</div>

<!-- MODAL CONFIRMAR ELIMINAR -->
<div class="modal-backdrop" *ngIf="showConfirmDelete">
  <div class="modal-card">
    <h2>Eliminar productos</h2>
    <p *ngIf="selectedIds.size === 1">
      ¿Seguro que quieres eliminar el producto seleccionado?
    </p>
    <p *ngIf="selectedIds.size > 1">
      ¿Seguro que quieres eliminar {{ selectedIds.size }} productos?
    </p>

    <div class="modal-actions">
      <button class="btn btn-cancel"
              type="button"
              (click)="showConfirmDelete = false"
              [disabled]="loading">
        Cancelar
      </button>
      <button class="btn btn-delete"
              type="button"
              (click)="confirmDelete()"
              [disabled]="loading">
        Aceptar
      </button>
    </div>
  </div>
</div>
